#!/usr/bin/env bash

file=$(realpath "$1")
if [ ! -f "$file" ];then
    echo "$file not found"
    exit
fi
dir=$(dirname "$file")
while [[ ! -f "$dir/requirements.txt" && ! -f "$dir/pyproject.toml" && "$dir" != "/" ]];do
    dir=$(dirname "$dir")
done
if [[ "$dir" == "/" ]];then
    shift
    echo "> project dir not found, running with system python"
    python "$file" "$@"
    exit
fi
echo "> project dir detected as $dir"

cd "$dir" || exit
full_version=$(python -c "import platform;print(platform.python_version())")
version=$(echo "$full_version" | sed -e "s/\.[0-9]\+\$//")
python="$dir/venv/bin/python$version"
activate="$dir/venv/bin/activate"

if [ -d "$dir/venv" ];then
    if [ ! -f "$python" ];then
        echo "> deleting existing venv"
        rm -rf "$dir/venv"
    fi
fi
if [ ! -f "$python" ];then
    echo "> creating venv"
    python -m venv "$dir/venv"
    source "$activate"
    if [ -f "$dir/requirements.txt" ];then
        pip install -r "$dir/requirements.txt"
    fi
    pip install "$dir"
    echo "> sourced, installed and done"
else
    source "$activate"
fi
shift
echo "$ $python"
"$python" "$file" "$@"
